@model IEnumerable<ToursAndTravelsManagement.Models.CabRoutePrice>
@using ToursAndTravelsManagement.Enums

@{
    ViewData["Title"] = "Manage Cab Prices";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-money-bill-wave mr-2"></i>Manage Cab Prices
            </h1>
            <p class="text-muted mb-0">Configure cab pricing for different routes and journey types</p>
        </div>
        <a asp-action="CreateCabPrice" class="btn btn-primary">
            <i class="fas fa-plus-circle mr-1"></i> Add New Price
        </a>
    </div>

    <!-- Alerts -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle mr-2"></i> @TempData["Success"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle mr-2"></i> @TempData["Error"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }
    @if (TempData["Warning"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle mr-2"></i> @TempData["Warning"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Prices
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count()</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Available
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.Count(c => c.IsAvailable)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                One-Way
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.Count(c => c.JourneyType == JourneyType.OneWay)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-arrow-right fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Outstation
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.Count(c => c.JourneyType == JourneyType.Outstation)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-road fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Stats -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                Local
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.Count(c => c.JourneyType == JourneyType.Local)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-map-marker-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Transfer
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.Count(c => c.JourneyType == JourneyType.Transfer)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exchange-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-dark shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-dark text-uppercase mb-1">
                                Total Revenue (Est.)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                ₹@Model.Where(c => c.IsAvailable).Sum(c => c.Price).ToString("N0")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-rupee-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-purple shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-purple text-uppercase mb-1">
                                Avg. Price
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                ₹@(Model.Any() ? Model.Average(c => c.Price).ToString("N0") : "0")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cab Prices Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-primary text-white">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-list mr-2"></i> All Cab Prices
            </h6>
            <div class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button"
                        id="filterDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-filter mr-1"></i> Filter
                </button>
                <div class="dropdown-menu" aria-labelledby="filterDropdown">
                    <a class="dropdown-item" asp-action="ManageCabPrices">All Prices</a>
                    <div class="dropdown-divider"></div>
                    <h6 class="dropdown-header">By Availability</h6>
                    <a class="dropdown-item" href="?status=available">Available Only</a>
                    <a class="dropdown-item" href="?status=unavailable">Unavailable Only</a>
                    <div class="dropdown-divider"></div>
                    <h6 class="dropdown-header">By Journey Type</h6>
                    <a class="dropdown-item" href="?journeyType=OneWay">One-Way</a>
                    <a class="dropdown-item" href="?journeyType=Outstation">Outstation</a>
                    <a class="dropdown-item" href="?journeyType=Local">Local</a>
                    <a class="dropdown-item" href="?journeyType=Transfer">Transfer</a>
                </div>
            </div>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="cabPricesTable" width="100%" cellspacing="0">
                        <thead class="thead-light">
                            <tr>
                                <th>ID</th>
                                <th><i class="fas fa-car mr-1"></i> Cab Details</th>
                                <th><i class="fas fa-route mr-1"></i> Route</th>
                                <th><i class="fas fa-directions mr-1"></i> Journey</th>
                                <th><i class="fas fa-rupee-sign mr-1"></i> Price</th>
                                <th><i class="fas fa-toggle-on mr-1"></i> Status</th>
                                <th><i class="fas fa-calendar-alt mr-1"></i> Created</th>
                                <th><i class="fas fa-cogs mr-1"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cabPrice in Model)
                            {
                                <tr>
                                    <td>@cabPrice.CabRoutePriceId</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="mr-3">
                                                <i class="fas fa-car fa-2x text-primary"></i>
                                            </div>
                                            <div>
                                                <strong>@cabPrice.Cab?.Name</strong>
                                                <div class="text-muted small">
                                                    @cabPrice.Cab?.Type • @cabPrice.Cab?.SeatingCapacity seats
                                                </div>
                                                <div class="text-muted smaller">
                                                    Reg: @cabPrice.Cab?.RegistrationNumber
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="route-info">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-map-marker-alt text-danger mr-2"></i>
                                                <span class="font-weight-bold">@cabPrice.Route?.FromCity?.Name</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-map-marker text-success mr-2"></i>
                                                <span class="font-weight-bold">@cabPrice.Route?.ToCity?.Name</span>
                                            </div>
                                            <div class="text-muted small mt-1">
                                                <i class="fas fa-road mr-1"></i>
                                                @cabPrice.Route?.Distance.ToString("N1") km
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @{
                                            var journeyBadgeClass = cabPrice.JourneyType switch
                                            {
                                                JourneyType.OneWay => "badge-warning",
                                                JourneyType.Outstation => "badge-primary",
                                                JourneyType.Local => "badge-info",
                                                JourneyType.Transfer => "badge-secondary",
                                                _ => "badge-light"
                                            };
                                            var journeyIcon = cabPrice.JourneyType switch
                                            {
                                                JourneyType.OneWay => "fa-arrow-right",
                                                JourneyType.Outstation => "fa-road",
                                                JourneyType.Local => "fa-map-marker-alt",
                                                JourneyType.Transfer => "fa-exchange-alt",
                                                _ => "fa-question"
                                            };
                                        }
                                        <span class="badge @journeyBadgeClass">
                                            <i class="fas @journeyIcon mr-1"></i> @cabPrice.JourneyType
                                        </span>
                                    </td>
                                    <td>
                                        <div class="h5 mb-0 font-weight-bold text-success">
                                            ₹@cabPrice.Price.ToString("N0")
                                        </div>
                                        @if (!string.IsNullOrEmpty(cabPrice.ExtraCharges))
                                        {
                                            <small class="text-muted">+ @cabPrice.ExtraCharges</small>
                                        }
                                    </td>
                                    <td>
                                        @if (cabPrice.IsAvailable)
                                        {
                                            <span class="badge badge-success">
                                                <i class="fas fa-check-circle mr-1"></i> Available
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-danger">
                                                <i class="fas fa-times-circle mr-1"></i> Unavailable
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div class="text-muted small">
                                            @cabPrice.CreatedDate.ToString("dd MMM yyyy")
                                        </div>
                                        <div class="text-muted smaller">
                                            by @cabPrice.CreatedBy
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a asp-action="EditCabPrice" asp-route-id="@cabPrice.CabRoutePriceId"
                                               class="btn btn-outline-primary" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a asp-action="CabPriceDetails" asp-route-id="@cabPrice.CabRoutePriceId"
                                               class="btn btn-outline-info" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <form asp-action="ToggleAvailability" method="post" class="d-inline">
                                                <input type="hidden" name="id" value="@cabPrice.CabRoutePriceId" />
                                                @if (cabPrice.IsAvailable)
                                                {
                                                    <button type="submit" class="btn btn-outline-warning" title="Deactivate"
                                                            onclick="return confirm('Are you sure you want to deactivate this price?')">
                                                        <i class="fas fa-toggle-on"></i>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button type="submit" class="btn btn-outline-success" title="Activate"
                                                            onclick="return confirm('Are you sure you want to activate this price?')">
                                                        <i class="fas fa-toggle-off"></i>
                                                    </button>
                                                }
                                            </form>
                                            <button type="button" class="btn btn-outline-danger"
                                                    onclick="confirmDelete(@cabPrice.CabRoutePriceId, '@cabPrice.Cab?.Name', '@cabPrice.Route?.FromCity?.Name', '@cabPrice.Route?.ToCity?.Name', '@cabPrice.JourneyType', @cabPrice.Price)"
                                                    title="Delete">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-money-bill-wave fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted">No Cab Prices Found</h4>
                    <p class="text-muted mb-4">Start by adding your first cab price configuration.</p>
                    <a asp-action="CreateCabPrice" class="btn btn-primary">
                        <i class="fas fa-plus-circle mr-1"></i> Add Your First Cab Price
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Delete
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage"></p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i> Cancel
                </button>
                <form id="deleteForm" asp-action="DeleteCabPrice" method="post">
                    <input type="hidden" id="deleteId" name="id" />
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt mr-1"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

            .card:hover {
                transform: translateY(-2px);
            }

        .card-header {
            border-radius: 10px 10px 0 0 !important;
            border: none;
        }

        .border-left-primary {
            border-left: 4px solid #4e73df !important;
        }

        .border-left-success {
            border-left: 4px solid #1cc88a !important;
        }

        .border-left-warning {
            border-left: 4px solid #f6c23e !important;
        }

        .border-left-info {
            border-left: 4px solid #36b9cc !important;
        }

        .border-left-secondary {
            border-left: 4px solid #858796 !important;
        }

        .border-left-danger {
            border-left: 4px solid #e74a3b !important;
        }

        .border-left-dark {
            border-left: 4px solid #5a5c69 !important;
        }

        .border-left-purple {
            border-left: 4px solid #6f42c1 !important;
        }

        .table thead th {
            background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
            border: none;
            padding: 15px 12px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

            .table tbody tr:hover {
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
                transform: scale(1.002);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            }

        .route-info {
            padding: 8px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-warning {
            background: linear-gradient(135deg, #f6e05e 0%, #d69e2e 100%);
            color: #1a202c;
        }

        .badge-primary {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }

        .badge-info {
            background: linear-gradient(135deg, #63b3ed 0%, #3182ce 100%);
            color: white;
        }

        .badge-secondary {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            color: white;
        }

        .badge-success {
            background: linear-gradient(135deg, #68d391 0%, #38a169 100%);
            color: white;
        }

        .badge-danger {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
        }

        .btn-group {
            gap: 4px;
        }

            .btn-group .btn {
                border-radius: 6px;
                transition: all 0.3s ease;
                padding: 4px 8px;
                font-size: 0.875rem;
            }

                .btn-group .btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                }

        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .btn-outline-info:hover {
            background: linear-gradient(135deg, #4fd1c5 0%, #319795 100%);
            border-color: #4fd1c5;
            color: white;
        }

        .btn-outline-warning:hover {
            background: linear-gradient(135deg, #f6e05e 0%, #d69e2e 100%);
            border-color: #f6e05e;
            color: #1a202c;
        }

        .btn-outline-success:hover {
            background: linear-gradient(135deg, #68d391 0%, #38a169 100%);
            border-color: #68d391;
            color: white;
        }

        .btn-outline-danger:hover {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            border-color: #fc8181;
            color: white;
        }

        .text-xs {
            font-size: 0.7rem !important;
        }

        .smaller {
            font-size: 0.75rem;
        }

        .text-purple {
            color: #6f42c1 !important;
        }

        .border-left-purple {
            border-left-color: #6f42c1 !important;
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize DataTable
            $('#cabPricesTable').DataTable({
                "pageLength": 10,
                "order": [[0, 'desc']],
                "responsive": true,
                "language": {
                    "emptyTable": "No cab prices available",
                    "search": "Search:",
                    "paginate": {
                        "previous": "<i class='fas fa-chevron-left'></i>",
                        "next": "<i class='fas fa-chevron-right'></i>"
                    },
                    "lengthMenu": "Show _MENU_ entries",
                    "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                    "infoEmpty": "Showing 0 to 0 of 0 entries"
                },
                "columnDefs": [
                    { "orderable": false, "targets": [7] }
                ]
            });

            // Auto-dismiss alerts
            setTimeout(function () {
                $('.alert').alert('close');
            }, 5000);

            // Highlight row on hover
            $('#cabPricesTable tbody tr').hover(
                function () {
                    $(this).addClass('hover-row');
                },
                function () {
                    $(this).removeClass('hover-row');
                }
            );
        });

        function confirmDelete(id, cabName, fromCity, toCity, journeyType, price) {
            $('#deleteMessage').html(`
                        <p>Are you sure you want to delete this cab price configuration?</p>
                        <table class="table table-sm">
                            <tr>
                                <th>Route:</th>
                                <td>${fromCity} → ${toCity}</td>
                            </tr>
                            <tr>
                                <th>Cab:</th>
                                <td>${cabName}</td>
                            </tr>
                            <tr>
                                <th>Journey Type:</th>
                                <td>${journeyType}</td>
                            </tr>
                            <tr>
                                <th>Price:</th>
                                <td class="font-weight-bold">₹${price}</td>
                            </tr>
                        </table>
                    `);
            $('#deleteId').val(id);
            $('#deleteModal').modal('show');
        }

        // Toggle availability confirmation
        $(document).on('submit', 'form[action*="ToggleAvailability"]', function (e) {
            var isActivating = $(this).find('.btn-outline-success').length > 0;
            var action = isActivating ? 'activate' : 'deactivate';
            var routeInfo = $(this).closest('tr').find('.route-info').text().trim();
            var cabInfo = $(this).closest('tr').find('td:nth-child(2) strong').text();

            if (!confirm(`Are you sure you want to ${action} price for:\n${cabInfo}\nRoute: ${routeInfo}?`)) {
                e.preventDefault();
                return false;
            }
            return true;
        });
    </script>
}